

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.11. Running With Docker &mdash; Ambry 0.3.2049 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Ambry 0.3.2049 documentation" href="../index.html"/>
        <link rel="up" title="3. Process Reference" href="index.html"/>
        <link rel="next" title="3.12. Tips" href="tips.html"/>
        <link rel="prev" title="3.10. Web API" href="api.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Ambry
          

          
          </a>

          
            
            
              <div class="version">
                0.3.2049
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install_config/index.html">1. Install and Configure Ambry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">2. Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="bundle.html">3.1. The Bundle Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="sourceconfig.html">3.2. Configuring Sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="source_schema.html">3.3. Source Schemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="dest_schema.html">3.4. Destination Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipelines.html">3.5. Row Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="transforms.html">3.6. Column Transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="library.html">3.7. The Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="remotes.html">3.8. Remote Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="webui.html">3.9. Web User Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html">3.10. Web API</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.11. Running With Docker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initial-setup">3.11.1. Initial Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-images">3.11.2. Building Images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-container-group">3.11.3. Create a Container Group</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">3.11.4. Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#environmental-variables">3.11.4.1. Environmental Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ambry-yaml-configuration">3.11.4.2. Ambry.yaml Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#other-issues">3.11.5. Other Issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ui-proxies">3.11.5.1. UI Proxies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tips.html">3.12. Tips</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">4. Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">5. Concepts and Design Overview</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Ambry</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">3. Process Reference</a> &raquo;</li>
      
    <li>3.11. Running With Docker</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/process/docker.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="running-with-docker">
<h1>3.11. Running With Docker<a class="headerlink" href="#running-with-docker" title="Permalink to this headline">¶</a></h1>
<p>Using docker with Amby makes it much easier to build bundles with multiple processes on multiple machines.</p>
<p>Ambry runs in docker with these containers:</p>
<ul class="simple">
<li>A volume container, for holding downloaded files and built bundles</li>
<li>A postgres database container, which holds the library database and warehouses</li>
<li>One or more transient builders containers, to build bundles and run other Ambry commands.</li>
<li>A UI container, to run the web interface to the library.</li>
</ul>
<p>These containers can be build and run using either the <strong class="command">python setup.py docker</strong> command, or with <strong class="command">docker compose</strong>. Additionally, the <strong class="command">bambry docker</strong> command allows running Ambry commands in a transient container, automatically connected to the database and volume container.</p>
<div class="section" id="initial-setup">
<h2>3.11.1. Initial Setup<a class="headerlink" href="#initial-setup" title="Permalink to this headline">¶</a></h2>
<p>Of course, you will need to setup docker first. For development and testing on Max and Windows, it is easiest to use a destktop docker environment like <a class="reference external" href="https://kitematic.com/">Kitematic</a>,  while for Linux you can <a class="reference external" href="https://docs.docker.com/linux/step_one/">install docker directly</a>.</p>
<p>After you have docker working, you will need to:
- Build all of the Ambry docker images on yout host
- Create a container group</p>
</div>
<div class="section" id="building-images">
<h2>3.11.2. Building Images<a class="headerlink" href="#building-images" title="Permalink to this headline">¶</a></h2>
<p>The <strong class="command">python setup.py docker</strong> command is used to build and tag images for the various container types. The command has these options, each to build a different container type:</p>
<dl class="option">
<dt id="cmdoption">
<code class="descname">--</code><code class="descclassname"> base</code><code class="descclassname">, </code><code class="descname">--B</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Builds the base container, <cite>civicknowledge/base</cite>, used by other containers.</p>
<dl class="option">
<dt id="cmdoption-build">
<code class="descname">--build</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">-b</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-build" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Builds the builder container, which is launched from <strong class="command">bambry docker</strong></p>
<ul class="simple">
<li><code class="xref std std-option docutils literal"><span class="pre">--dev</span> <span class="pre">|</span> <span class="pre">-d</span></code> Builds the same container as - <code class="xref std std-option docutils literal"><span class="pre">--build,</span></code> but installs some packages from git rather than pip, so it is easier to use in development.</li>
<li><code class="xref std std-option docutils literal"><span class="pre">--db</span> <span class="pre">|</span> <span class="pre">-D</span></code> Builds the postgres database image</li>
<li><code class="xref std std-option docutils literal"><span class="pre">--tunnel</span> <span class="pre">|</span> <span class="pre">-t</span></code> Builds the image for an SSH tunnel to access remote databases securely.</li>
<li><code class="xref std std-option docutils literal"><span class="pre">--ui</span> <span class="pre">|</span> <span class="pre">-u</span></code> Builds the image for the web user interface to a library;</li>
<li><code class="xref std std-option docutils literal"><span class="pre">--volumes</span> <span class="pre">|</span> <span class="pre">-v</span></code> Builds the image for containers that hold data for a group of related containers.</li>
</ul>
<p>Or, just use <code class="xref std std-option docutils literal"><span class="pre">-a</span></code> to build everything.</p>
<p>The - <code class="xref std std-option docutils literal"><span class="pre">--build</span> <span class="pre">|</span> <span class="pre">-b</span></code> and - <code class="xref std std-option docutils literal"><span class="pre">--dev</span> <span class="pre">|</span> <span class="pre">-d</span></code> options build the same container, with the same tags, so only one is required. The <cite>dev</cite> image gets some very actively developed modules from github, while the <cite>build</cite> image gets them from <strong class="command">pip</strong>, so the <cite>dev</cite> image is preferred for use in development.</p>
</div>
<div class="section" id="create-a-container-group">
<h2>3.11.3. Create a Container Group<a class="headerlink" href="#create-a-container-group" title="Permalink to this headline">¶</a></h2>
<p>A container group is a colelction of interacting Ambry container for a single library. You will create a container group for each seperate library you want to work with. The groups have a group name, which you can set with the <code class="xref std std-option docutils literal"><span class="pre">-g</span> <span class="pre">|</span> <span class="pre">--groupname</span></code> option, or you can let the system choose a random name.</p>
<p>To create a container group, run <strong class="command">ambry docker init</strong>. If you are running in a non-public environment, use the <code class="xref std std-option docutils literal"><span class="pre">-p</span> <span class="pre">|</span> <span class="pre">--public</span></code> option to add a port marring for the database container. In a public environment &#8211; for instance, your docker host is at AWS or Digital Ocean &#8211;  omit and  <code class="xref std std-option docutils literal"><span class="pre">-p</span> <span class="pre">|</span> <span class="pre">--public</span></code> option. In this case, you will need to use the <strong class="command">ambry docker tunnel</strong> command to create a secure SSH tunnel to remotely access your database, or perform Ambry operations from a container on the same host.</p>
<p>To create a container group for the group name <cite>demo</cite>, with a public database port, run:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ambry docker init -g demo -p -m<span class="s1">&#39;This is a demo library&#39;</span>
</pre></div>
</div>
<p>After the container group is created, you will need to configure the database DSN for the new database. You can either set the DSN that is print to the screen in the <code class="xref std std-option docutils literal"><span class="pre">library.database</span></code> config in your <code class="file docutils literal"><span class="pre">.ambry.yaml</span></code> file, or you can set the <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal"><span class="pre">AMBRY_DB</span></code> environmental variable. Set the <code class="xref std std-option docutils literal"><span class="pre">library.database</span></code> if you only expect to work with one database, and set  <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal"><span class="pre">AMBRY_DB</span></code> environmental variable if you expect to work with many.</p>
<p>If you have setup the <code class="file docutils literal"><span class="pre">ambry-aliases.sh</span></code> file ( find it with <strong class="command">which ambry-aliases.sh</strong>, then source it in your <code class="file docutils literal"><span class="pre">.bashrc</span></code> or <code class="file docutils literal"><span class="pre">.bash_profile</span></code> ) you can run the <strong class="command">ambry_switch</strong> function to set the <span class="target" id="index-2"></span><code class="xref std std-envvar docutils literal"><span class="pre">AMBRY_DB</span></code> environmental variable to the DSN associated with a group name. For instance, after creating the <cite>demo</cite> group:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">source</span> <span class="sb">`</span>which ambry-aliases.sh<span class="sb">`</span>
$ ambry_switch demo
$ printenv AMBRY_DB
postgres://demo:ume9qnwwlgxl@192.168.1.30:32827/26joo6xskj05?docker
</pre></div>
</div>
</div>
<div class="section" id="configuration">
<h2>3.11.4. Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="environmental-variables">
<h3>3.11.4.1. Environmental Variables<a class="headerlink" href="#environmental-variables" title="Permalink to this headline">¶</a></h3>
<p>The docker container for building bundles uses several environmental variables to configure it&#8217;s operation.</p>
<ul class="simple">
<li><span class="target" id="index-3"></span><code class="xref std std-envvar docutils literal"><span class="pre">AMBRY_DB</span></code> Database DSN for the AMbry library</li>
<li><span class="target" id="index-4"></span><code class="xref std std-envvar docutils literal"><span class="pre">AMBRY_ACCOUNT_PASSWORD</span></code> The password for decrypting account secrets</li>
<li><span class="target" id="index-5"></span><code class="xref std std-envvar docutils literal"><span class="pre">AMBRY_LIMITED_RUN</span></code> When building in docker, use <cite>-L</cite></li>
<li><span class="target" id="index-6"></span><code class="xref std std-envvar docutils literal"><span class="pre">AMBRY_COMMAND</span></code>. Start the container with this ambry command, then exit.</li>
</ul>
</div>
<div class="section" id="ambry-yaml-configuration">
<h3>3.11.4.2. Ambry.yaml Configuration<a class="headerlink" href="#ambry-yaml-configuration" title="Permalink to this headline">¶</a></h3>
<p>The <code class="file docutils literal"><span class="pre">ambry.yaml</span></code> file can have a few configuration items that effect
operation of docker containers.</p>
<p>The <code class="xref std std-option docutils literal"><span class="pre">docker.volumes_from</span></code> config specifies a single argument for the <code class="xref std std-option docutils literal"><span class="pre">--volumes-from</span></code> argument when running <strong class="command">bambry docker</strong>. The option allows for creating a volume container to hold build files. You&#8217;ll nearly always want to set this value; if it isn&#8217;t set, the files created during a build will be lost when the container exits.</p>
<p>The <code class="xref std std-option docutils literal"><span class="pre">docker.ambry_image</span></code> config specified the image that is used when running <strong class="command">bambry docker</strong>. This config is useful to set <strong class="command">bambry docker</strong> to use the image created with  <strong class="command">docker compose</strong></p>
<p>If you use <strong class="command">docker compose</strong> to create the docker images instead of <strong class="command">python setup.py docker</strong>, these configuration values will be useful to ensure <strong class="command">bambry docker</strong> uses the images created by  <strong class="command">docker compose</strong>.</p>
<p>The UI containers are hard to use if you have to run <strong class="command">docker ps</strong> to find the host port, so it is more useful to setup a web proxy to rount we requests to the host to the UI containers. The <code class="docutils literal"><span class="pre">jwilder/nginx-proxy</span></code> is an easy way set up these proxies automatically. When the ui containers are created, a <span class="target" id="index-7"></span><code class="xref std std-envvar docutils literal"><span class="pre">VIRTUAL_HOST</span></code> environmental variable is automatically set, so the <code class="docutils literal"><span class="pre">jwilder/nginx-proxy</span></code> can automatically configure a proxy entry. When this proxy is in place, the <code class="xref std std-option docutils literal"><span class="pre">docker.ui_domain</span></code> is used for the root domain of the virtual host.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">docker</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">volumes_from</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ambrydocker_volumes</span>
    <span class="l l-Scalar l-Scalar-Plain">ambry_image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ambrydocker_ambry</span>
    <span class="l l-Scalar l-Scalar-Plain">ui_domain</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">barker.local</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="other-issues">
<h2>3.11.5. Other Issues<a class="headerlink" href="#other-issues" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ui-proxies">
<h3>3.11.5.1. UI Proxies<a class="headerlink" href="#ui-proxies" title="Permalink to this headline">¶</a></h3>
<p>To run a  UI proxy that will automatically configure from the UI containers&#8217; <span class="target" id="index-8"></span><code class="xref std std-envvar docutils literal"><span class="pre">VIRTUAL_HOST</span></code> environmental variable:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ docker run -d -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tips.html" class="btn btn-neutral float-right" title="3.12. Tips" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="api.html" class="btn btn-neutral" title="3.10. Web API" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Civic Knowledge.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.3.2049',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>